<div class="header-bar">
  <h2>–ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–µ–º—è–Ω</h2>
  <input
    type="text"
    placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
    class="search-input"
    [(ngModel)]="searchTerm"
    (ngModelChange)="onSearchChange()"
  />
  <button *ngIf="isAdmin()" (click)="startAdd()" class="btn-add">
    ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ–º—è
  </button>
</div>

<div *ngIf="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>
<div *ngIf="error" class="error">{{ error }}</div>

<div *ngIf="!loading && !error" class="seed-table-wrapper">
  <table class="seed-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <th class="header-cell" (click)="toggleFilter('specie', $event)">
          –í–∏–¥
          <span *ngIf="sortColumn === 'specie'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="header-cell" (click)="toggleFilter('genus', $event)">
          –†–æ–¥
        </th>
        <th class="header-cell" (click)="toggleFilter('family', $event)">
          –°–µ–º–µ–π—Å—Ç–≤–æ
        </th>
        <!-- –î–∞—Ç–∞ –∏ —á–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <th class="sortable-header" (click)="setSort('date_of_collection')">
          –î–∞—Ç–∞ —Å–±–æ—Ä–∞
          <span *ngIf="sortColumn === 'date_of_collection'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('completed_seeds')">
          –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö
          <span *ngIf="sortColumn === 'completed_seeds'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('seed_germination')">
          –í—Å—Ö–æ–∂–µ—Å—Ç—å
          <span *ngIf="sortColumn === 'seed_germination'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('seed_moisture')">
          –í–ª–∞–∂–Ω–æ—Å—Ç—å
          <span *ngIf="sortColumn === 'seed_moisture'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('gpsaltitude')">
          GPS –≤—ã—Å–æ—Ç–∞
          <span *ngIf="sortColumn === 'gpsaltitude'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('gpslatitude')">
          GPS —à–∏—Ä–æ—Ç–∞
          <span *ngIf="sortColumn === 'gpslatitude'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('gpslongitude')">
          GPS –¥–æ–ª–≥–æ—Ç–∞
          <span *ngIf="sortColumn === 'gpslongitude'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('weight_of1000seeds')">
          –í–µ—Å 1000
          <span *ngIf="sortColumn === 'weight_of1000seeds'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <th class="sortable-header" (click)="setSort('number_of_seeds')">
          –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
          <span *ngIf="sortColumn === 'number_of_seeds'">
            {{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}
          </span>
        </th>
        <!-- –ï—â—ë —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <th class="header-cell" (click)="toggleFilter('redBookRF', $event)">
          –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–∏–≥–∞ –†–§
        </th>
        <th class="header-cell" (click)="toggleFilter('redBookSO', $event)">
          –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–∏–≥–∞ –°–û
        </th>
        <th class="header-cell" (click)="toggleFilter('place', $event)">
          –ú–µ—Å—Ç–æ —Å–±–æ—Ä–∞
        </th>
        <th *ngIf="isAdmin()">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let s of paginatedSeeds">
        <td>{{ s.seed_id }}</td>
        <td>
          <a [routerLink]="['/seeds', s.seed_id]" class="clickable-link">
            {{ s.seed_name }}
          </a>
        </td>
        <td>{{ s.Specie.name_of_specie }}</td>
        <td>{{ s.Specie.Genus.name_of_genus }}</td>
        <td>{{ s.Specie.Genus.Family.name_of_family }}</td>
        <td>{{ s.date_of_collection | date: 'yyyy-MM-dd' }}</td>
        <td>{{ s.completed_seeds }}</td>
        <td>{{ s.seed_germination }}</td>
        <td>{{ s.seed_moisture }}</td>
        <td>{{ s.gpsaltitude }}</td>
        <td>{{ s.gpslatitude }}</td>
        <td>{{ s.gpslongitude }}</td>
        <td>{{ s.weight_of1000seeds }}</td>
        <td>{{ s.number_of_seeds }}</td>
        <td>{{ s.RedBookRF.category }}</td>
        <td>{{ s.RedBookSO.category }}</td>
        <td>{{ s.PlaceOfCollection.place_of_collection }}</td>
        <td *ngIf="isAdmin()">
          <button (click)="startEdit(s)" class="btn-edit">‚úé</button>
          <button (click)="deleteSeed(s)" class="btn-delete">üóë</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º -->
<div *ngIf="!loading && !error" class="pagination-container">
  <button (click)="prevPage()" [disabled]="currentPage === 1">
    ‚óÄ –ü—Ä–µ–¥.
  </button>
  <ng-container *ngFor="let _ of [].constructor(totalPages); let i = index">
    <button
      [ngClass]="{ 'active-page': currentPage === i + 1 }"
      (click)="goToPage(i + 1)"
    >
      {{ i + 1 }}
    </button>
  </ng-container>
  <button (click)="nextPage()" [disabled]="currentPage === totalPages">
    –°–ª–µ–¥. ‚ñ∂
  </button>
</div>

<!-- –í–Ω–µ—à–Ω–∏–µ dropdown‚Äô—ã -->
<div
  *ngIf="filterToggles['specie']"
  class="dropdown"
  [style.top.px]="getDropdownPosition('specie').y"
  [style.left.px]="getDropdownPosition('specie').x"
>
  <ul>
    <li (click)="applyFilter('specie', '', $event)">–í—Å–µ</li>
    <li
      *ngFor="let v of getUniqueValues('specie')"
      (click)="applyFilter('specie', v, $event)"
    >
      {{ v }}
    </li>
  </ul>
</div>

<div
  *ngIf="filterToggles['genus']"
  class="dropdown"
  [style.top.px]="getDropdownPosition('genus').y"
  [style.left.px]="getDropdownPosition('genus').x"
>
  <ul>
    <li (click)="applyFilter('genus', '', $event)">–í—Å–µ</li>
    <li
      *ngFor="let v of getUniqueValues('genus')"
      (click)="applyFilter('genus', v, $event)"
    >
      {{ v }}
    </li>
  </ul>
</div>

<div
  *ngIf="filterToggles['family']"
  class="dropdown"
  [style.top.px]="getDropdownPosition('family').y"
  [style.left.px]="getDropdownPosition('family').x"
>
  <ul>
    <li (click)="applyFilter('family', '', $event)">–í—Å–µ</li>
    <li
      *ngFor="let v of getUniqueValues('family')"
      (click)="applyFilter('family', v, $event)"
    >
      {{ v }}
    </li>
  </ul>
</div>

<div
  *ngIf="filterToggles['redBookRF']"
  class="dropdown"
  [style.top.px]="getDropdownPosition('redBookRF').y"
  [style.left.px]="getDropdownPosition('redBookRF').x"
>
  <ul>
    <li (click)="applyFilter('redBookRF', '', $event)">–í—Å–µ</li>
    <li
      *ngFor="let v of getUniqueValues('redBookRF')"
      (click)="applyFilter('redBookRF', v, $event)"
    >
      {{ v }}
    </li>
  </ul>
</div>

<div
  *ngIf="filterToggles['redBookSO']"
  class="dropdown"
  [style.top.px]="getDropdownPosition('redBookSO').y"
  [style.left.px]="getDropdownPosition('redBookSO').x"
>
  <ul>
    <li (click)="applyFilter('redBookSO', '', $event)">–í—Å–µ</li>
    <li
      *ngFor="let v of getUniqueValues('redBookSO')"
      (click)="applyFilter('redBookSO', v, $event)"
    >
      {{ v }}
    </li>
  </ul>
</div>

<div
  *ngIf="filterToggles['place']"
  class="dropdown"
  [style.top.px]="getDropdownPosition('place').y"
  [style.left.px]="getDropdownPosition('place').x"
>
  <ul>
    <li (click)="applyFilter('place', '', $event)">–í—Å–µ</li>
    <li
      *ngFor="let v of getUniqueValues('place')"
      (click)="applyFilter('place', v, $event)"
    >
      {{ v }}
    </li>
  </ul>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ -->
<div
  class="modal-backdrop"
  *ngIf="editingSeed !== null"
  (click)="cancelEdit()"
></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div *ngIf="editingSeed !== null" class="modal">
  <h3>{{ editingSeed ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å' }} —Å–µ–º—è</h3>
  <form [formGroup]="editorForm" (ngSubmit)="saveSeed()">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
    <input formControlName="seed_name" />

    <label>–í–∏–¥</label>
    <select formControlName="specie_id">
      <option *ngFor="let sp of species" [value]="sp.id">
        {{ sp.name_of_specie }}
      </option>
    </select>

    <label>–î–∞—Ç–∞ —Å–±–æ—Ä–∞</label>
    <input type="date" formControlName="date_of_collection" />

    <label>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö</label>
    <input formControlName="completed_seeds" />

    <label>–í—Å—Ö–æ–∂–µ—Å—Ç—å</label>
    <input formControlName="seed_germination" />

    <label>–í–ª–∞–∂–Ω–æ—Å—Ç—å</label>
    <input formControlName="seed_moisture" />

    <label>GPS –≤—ã—Å–æ—Ç–∞</label>
    <input formControlName="gpsaltitude" />

    <label>GPS –¥–æ–ª–≥–æ—Ç–∞</label>
    <input formControlName="gpslongitude" />

    <label>GPS —à–∏—Ä–æ—Ç–∞</label>
    <input formControlName="gpslatitude" />

    <label>–í–µ—Å —Ç—ã—Å—è—á–∏ —Å–µ–º—è–Ω</label>
    <input formControlName="weight_of1000seeds" />

    <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
    <input type="file" (change)="onFileSelected($event)" />

    <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –†–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞–º–º—ã</label>
    <input type="file" (change)="onXrayImageSelected($event)" />

    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
    <input type="number" formControlName="number_of_seeds" />

    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
    <input formControlName="comment" />

    <label>–ö—Ä–∞—Å–Ω–∞—è –∫–Ω–∏–≥–∞ –†–§</label>
    <select formControlName="red_book_rf_id">
      <option *ngFor="let r of redBooksRF" [value]="r.id">
        {{ r.category }}
      </option>
    </select>

    <label>–ö—Ä–∞—Å–Ω–∞—è –∫–Ω–∏–≥–∞ –°–û</label>
    <select formControlName="red_book_so_id">
      <option *ngFor="let r of redBooksSO" [value]="r.id">
        {{ r.category }}
      </option>
    </select>

    <label>–ú–µ—Å—Ç–æ —Å–±–æ—Ä–∞</label>
    <select formControlName="place_of_collection_id">
      <option *ngFor="let p of places" [value]="p.id">
        {{ p.place_of_collection }}
      </option>
    </select>

    <div class="buttons">
      <button type="submit" [disabled]="editorForm.invalid">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" (click)="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </form>
</div>
